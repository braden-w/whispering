# Whispering v7.0.0 - Complete Architecture Rewrite

## üöÄ Major Release Highlights

Whispering v7.0.0 represents the most significant architectural overhaul in the project's history. This release completely rewrites the application's data layer, service architecture, and UI foundations to deliver a more robust, maintainable, and performant experience.

**Impact by the Numbers:**
- 488 files changed
- 23,798 lines added
- 34,936 lines removed
- Net reduction of ~11,000 lines through better code organization

---

## üî• **Complete TanStack Query Integration**

The biggest change in v7.0.0 is the ground-up rewrite using **TanStack Query** for all data management. This isn't just a dependency swap‚Äîit's a complete architectural transformation.

### What is TanStack Query?
TanStack Query is the industry-leading data synchronization library that provides:
- **Intelligent caching** - Data is cached automatically and reused across components
- **Background refetching** - Keeps your data fresh without user intervention
- **Optimistic updates** - UI responds immediately to user actions
- **Error handling** - Comprehensive error states and retry logic
- **Request deduplication** - Multiple components requesting the same data trigger only one network request

**Note**: We're using a custom fork of TanStack Query optimized for Svelte 5 compatibility. We also made an internal `_utils` file that gives us query/mutation option factories, direct query/mutations without subscriptions, and enhanced Result type handling.

### The New Query Layer Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     UI      ‚îÇ --> ‚îÇ    Query    ‚îÇ --> ‚îÇ   Services   ‚îÇ
‚îÇ Components  ‚îÇ     ‚îÇ    Layer    ‚îÇ     ‚îÇ    (Pure)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚Üë                    ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         Reactive Updates
```

**Key Benefits:**
- **Dual Interface**: Every operation supports both reactive (UI) and imperative (actions) usage
- **Type Safety**: Full TypeScript support with `Result<T, E>` types for error handling
- **Automatic Caching**: Data is cached intelligently and shared across components
- **Settings Integration**: Queries automatically react to settings changes
- **Optimistic Updates**: UI feels instant with automatic rollback on errors

### Example: Before vs After

**Before (v6.5.0):**
```typescript
// Multiple places doing direct service calls
const recordings = await db.getAllRecordings();
// Manual loading states, error handling, caching
```

**After (v7.0.0):**
```typescript
// Reactive in components
const recordings = createQuery(rpc.recordings.getAllRecordings.options());

// Imperative in actions
const { data, error } = await rpc.recordings.deleteRecording.execute(recordingId);
```

---

## üèóÔ∏è **Complete Service Layer Rewrite**

### New Service Architecture

The service layer has been completely restructured with a focus on:

1. **Platform Abstraction**: Clean separation between desktop, web, and extension implementations
2. **Dependency Injection**: Services are injected based on platform detection
3. **Pure Functions**: All services are pure functions with no side effects
4. **Result Types**: Migrated from `@epicenterhq/result` to `wellcrafted` library for consistent error handling
5. **Parameter Passing**: Services now accept explicit parameters (e.g., apiKey) instead of hidden dependencies
6. **RPC Layer**: New RPC layer for better separation of concerns between UI and services

### Service Categories

**Core Services:**
- `ClipboardService` - Platform-agnostic clipboard operations
- `NotificationService` - Cross-platform notifications
- `RecordingDbService` - Data persistence layer
- `TranscriptionService` - Audio-to-text conversion
- `RegisterShortcutsService` - Global and local keyboard shortcuts

**Implementation Strategy:**
- `*ServiceDesktopLive.ts` - Tauri/desktop implementations
- `*ServiceWebLive.ts` - Browser implementations
- `*ServiceExtensionLive.ts` - Chrome extension implementations

### Example Service Implementation

```typescript
// Clean interface definition
type ClipboardService = {
  writeText: (text: string) => Promise<Result<void, ClipboardError>>;
  readText: () => Promise<Result<string, ClipboardError>>;
};

// Platform-specific implementations
const ClipboardServiceDesktopLive: ClipboardService = {
  writeText: (text) => writeText(text), // Tauri API
};

const ClipboardServiceWebLive: ClipboardService = {
  writeText: (text) => navigator.clipboard.writeText(text), // Web API
};
```

---

## üé® **Comprehensive UI Overhaul**

### Modern Component Architecture

- **Shadcn-svelte Integration**: Complete migration to shadcn-svelte design system
- **Responsive Design**: Mobile-first approach with improved layouts
- **Component Consolidation**: Removed 50+ redundant components
- **Accessibility Improvements**: Better keyboard navigation and screen reader support

### Key UI Improvements

**Navigation & Mobile Experience:**
- **Mobile Dropdown Menu**: Navigation items now use a responsive dropdown menu on mobile
- **Improved Touch Targets**: Better spacing and sizing for mobile interactions
- **Responsive Layouts**: All components now work seamlessly on mobile devices

**Recording Interface:**
- Simplified recording controls with visual state indicators
- Dynamic device selection with fallback strategies
- Improved error messaging and user feedback

**Settings Redesign:**
- Streamlined settings panels with logical grouping
- Better visual hierarchy and information density
- Responsive layout that works on all screen sizes
- **New Persisted State**: Schema-validated settings with automatic migration

**Data Tables:**
- Complete rewrite using TanStack Table
- Improved performance with virtual scrolling
- Better sorting, filtering, and pagination

### Component System Changes

**Removed Components (Cleanup):**
- 24 accordion components consolidated
- 17 alert-dialog components streamlined
- 40+ command components simplified
- Multiple redundant table components removed

**Enhanced Components:**
- Button: Improved variants and loading states
- Input: Better validation and error states
- Select: Enhanced keyboard navigation
- Toast: Redesigned with better positioning and description support
- **CopyToClipboardButton**: New component with timeout and visual feedback
- **CopyableTextDialog**: New dialog for copying long text content
- **Alert**: Cleaner design with removed borders

---

## üîß **Advanced Features & Improvements**

### Keyboard Shortcuts Revolution

**Complete Shortcut System Rewrite:**
- **Global Shortcuts**: System-wide hotkeys that work anywhere
- **Local Shortcuts**: In-app shortcuts that work when Whispering is focused
- **Conflict Resolution**: Automatic detection and resolution of shortcut conflicts
- **Platform-Specific**: macOS, Windows, and Linux specific key handling
- **User-Friendly Recording**: Visual shortcut recorder with real-time feedback

**New Shortcut Features:**
- Support for complex key combinations
- **macOS Option Key Support**: Special handling for dead keys and special characters (‚Ä†, ‚àÇ, ∆í, etc.)
- Automatic fallback when shortcuts conflict
- Reset to defaults functionality
- Visual shortcut guides and help
- **Separate Settings Pages**: Dedicated pages for local and global shortcuts

### Recording Enhancements

**Multiple Recording Modes:**
- **Manual Recording**: Traditional push-to-talk/click-to-record
- **VAD (Voice Activity Detection)**: Automatic recording when speech detected
- **CPAL Recording**: Native audio recording with platform-specific optimizations

**Device Management:**
- **Smart Device Selection**: Automatic device enumeration with fallback
- **Device Persistence**: Remembers your preferred recording device
- **Device Switching**: Hot-swap between devices without restart

### Transcription Service Improvements

**New Transcription Providers:**
- **Speaches**: Replaced faster-whisper-server with more robust local transcription
- **Enhanced Groq**: Better error handling and file size validation
- **Improved OpenAI**: Direct SDK integration for better reliability
- **ElevenLabs**: Enhanced audio processing capabilities

**Transcription Features:**
- **Model Selection**: New dropdown UI for selecting specific models for OpenAI and ElevenLabs
- **Cost Display**: Shows model costs and descriptions directly in the selection UI
- **Better Error Messages**: Detailed error reporting with actionable suggestions and context
- **File Size Validation**: Automatic file size checking before upload (25MB limit for most services)
- **Retry Logic**: Intelligent retry with exponential backoff
- **Progress Tracking**: Real-time transcription progress updates

### Transformation Service Enhancements

**AI-Powered Text Processing:**
- **Anthropic SDK Integration**: Direct Claude API integration for transformations
- **Enhanced Completion Services**: Support for OpenAI, Groq, and Google Gemini
- **Working Copy Pattern**: Unsaved changes confirmation dialog in editors
- **Improved Error Context**: Better debugging information for failed transformations
- **Run History**: View and manage transformation run history with detailed logs

### Application Auto-Update System

**Built-in Update Management:**
- **Automatic Update Checks**: Periodic checks for new versions
- **Update Dialog**: User-friendly update notifications with release notes
- **One-Click Updates**: Seamless update installation using Tauri's updater plugin
- **Manual Check Option**: Check for updates on demand from the settings

---

## üõ†Ô∏è **Developer Experience Improvements**

### Build System & Tooling

**Updated Dependencies:**
- **Tauri v2.5.0**: Latest Tauri with improved security and performance
- **SvelteKit 2.22.0**: Latest SvelteKit with better SSR and routing
- **ESLint 9.27.0**: Modern linting with better TypeScript support
- **Tailwind 4.x**: Next-generation CSS framework with Vite integration
- **Pure Static Adapter**: Removed Vercel adapter for simpler static deployments

**Development Workflow:**
- **Simplified Scripts**: Streamlined development commands
- **Better Error Messages**: More helpful error reporting during development
- **Improved Hot Reload**: Faster development iteration cycles
- **Type Safety**: Enhanced TypeScript coverage with Brand types for nominal typing
- **Conventional Commits**: Enforced commit message format for better changelog generation
- **Circular Import Fixes**: Reorganized modules to eliminate circular dependencies

### Code Quality & Architecture

**Architectural Improvements:**
- **Separation of Concerns**: Clear boundaries between UI, query, and service layers
- **Testability**: Pure functions and dependency injection enable better testing
- **Maintainability**: Consistent patterns and clear documentation
- **Scalability**: Architecture designed to handle growing feature set

**Code Organization:**
- **Flattened Structure**: Simplified folder hierarchy
- **Clear Naming**: Consistent naming conventions across the codebase
- **Better Documentation**: Comprehensive JSDoc comments and README files
- **Type Definitions**: Improved TypeScript types and interfaces

---

## üö® **Breaking Changes**

### API Changes
- **Settings Schema**: Settings structure has been updated (automatic migration included)
- **Service Interfaces**: Complete rewrite of service layer APIs
  - Services now require explicit parameter passing (e.g., apiKey)
  - Removed singleton patterns in favor of dependency injection
  - New RPC layer for UI-service communication
- **Component Props**: Many component props have been renamed or restructured
- **Result Type Migration**: Moved from `@epicenterhq/result` to `wellcrafted` library

### Removed Features
- **Browser Extension**: Temporarily removed extension support (will be rebuilt in future)
- **Monorepo Structure**: Removed @repo/shared and @app/extension packages
- **Legacy Data Tables**: Old table components removed in favor of TanStack Table
- **Deprecated Services**: Old service implementations removed
- **Unused Components**: 100+ unused components removed to reduce bundle size
- **Vercel Adapter**: Switched to pure static builds

### Migration Guide
Most changes are handled automatically through:
- **Automatic Settings Migration**: Your existing settings are preserved with schema validation
- **Database Migration**: Recording data is automatically migrated
- **Graceful Fallbacks**: Unsupported configurations fall back to defaults
- **Shortcut Migration**: Keyboard shortcuts are automatically converted to new format

---

## üìä **Performance Improvements**

### Bundle Size Reduction
- **50% smaller bundle**: Removed unused dependencies and components
- **Better tree-shaking**: Improved dead code elimination
- **Lazy loading**: Components load only when needed

### Runtime Performance
- **Faster queries**: TanStack Query's intelligent caching reduces redundant requests
- **Optimized re-renders**: Svelte's fine-grained reactivity with better data flow
- **Memory usage**: Reduced memory footprint through better resource management

### User Experience
- **Instant UI responses**: Optimistic updates make the UI feel instant
- **Better error handling**: More informative error messages with recovery options
- **Improved accessibility**: Better screen reader support and keyboard navigation

## üêõ **Notable Bug Fixes**

- **Audio Import Paths**: Fixed broken audio imports in assets module
- **Global Shortcuts**: Resolved registration errors preventing shortcuts from working
- **Dialog Z-Index**: Fixed alert dialogs appearing behind regular dialogs
- **Recording Mode**: Fixed undefined mode error in recording mode selector
- **Device Fallback**: Added automatic fallback when preferred recording device is unavailable
- **macOS Shortcuts**: Fixed Option key producing unexpected characters in shortcuts
- **Toast Layout**: Fixed exclamation mark styling issues in toast notifications

---

## üîÆ **Future-Proofing**

### Extensibility
- **Plugin Architecture**: Service layer designed for easy extension
- **Platform Support**: Architecture ready for additional platforms
- **Feature Flags**: Infrastructure for gradual feature rollouts

### Maintainability
- **Clear Patterns**: Consistent architectural patterns throughout
- **Documentation**: Comprehensive code documentation and guides
- **Testing Infrastructure**: Foundation for comprehensive test coverage

---

## üéØ **Getting Started with v7.0.0**

### For Existing Users
1. **Backup your data** (automatic migration included, but safety first!)
2. **Update to v7.0.0** 
3. **Review your settings** - some options may have moved or changed
4. **Explore new features** - try the new recording modes and shortcuts

### For New Users
1. **Download the latest release**
2. **Follow the setup guide** in the documentation
3. **Configure your preferences** in the streamlined settings
4. **Start recording** with the improved interface

---

## üèÜ **What This Means for You**

**Immediate Benefits:**
- **Faster, more responsive UI** with intelligent caching
- **Better error handling** with clear, actionable messages
- **Improved reliability** with automatic retry logic
- **More intuitive interface** with simplified workflows

**Long-term Benefits:**
- **Future-proof architecture** ready for upcoming features
- **Better maintainability** means faster bug fixes and updates
- **Improved extensibility** for community contributions
- **Solid foundation** for the next phase of Whispering development

---

## üôè **Acknowledgments**

This massive rewrite represents months of careful planning, development, and testing. Special thanks to the open-source community for the excellent tools that made this possible:

- **TanStack Query** for the incredible data synchronization library
- **Svelte/SvelteKit** for the amazing reactive framework
- **Tauri** for the powerful desktop app platform
- **Shadcn-svelte** for the beautiful component library

---

## üìà **What's Next?**

v7.0.0 lays the foundation for exciting upcoming features:
- **Real-time collaboration** capabilities
- **Enhanced plugin system** for community extensions
- **Advanced analytics** and usage insights
- **Mobile app** support using the shared service layer
- **Cloud synchronization** for settings and recordings

---

**Download v7.0.0 today and experience the future of voice transcription!**

*Full changelog and technical details available in the repository.*